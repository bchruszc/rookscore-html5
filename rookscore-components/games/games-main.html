<link rel="import" href="../../imports.html">


<dom-module id="games-main">



    <template>
        <index-db db="{{db}}"></index-db>
        <game-controller id="gameController" db="[[db]]"></game-controller>
        <game-scoreboard game="[[game]]" scoreboard="[[scoreboard]]"></game-scoreboard>


        <paper-dialog id="addRoundDialog" on-iron-overlay-closed="addPlayerDialogClosed" style="border-left: 10px">
            <paper-dialog-scrollable style="border: 10px">
                <paper-material style="margin-left: 10px; margin-right: 10px; margin-top: 2px;   padding: 10px">
                    <round-editor id="roundEditor" players="{{listPlayers(game)}}" round="{{round}}"></round-editor>
                </paper-material>
            </paper-dialog-scrollable>

            <div class="buttons">
                <paper-button on-click="doCancelAddRound">Cancel</paper-button>
                <paper-button on-click="doAddRound">Add</paper-button>
            </div>
        </paper-dialog>


        <paper-fab on-click="addRoundClicked" icon="add"></paper-fab>


    </template>


    <script>
        Polymer({
            is: "games-main",

            properties: {
                gameId: {
                    type: String
                },

                game: {
                    type: Object,
                },

            },

            observers: [
                'gameIdAndDBSet(gameId, db)',
            ],


            gameIdAndDBSet: function() {
                var gameIdNum = parseInt(this.gameId);
                if (gameIdNum) {
                    var that = this;
                    this.$.gameController.get(gameIdNum, function(result) {
                        that.game = result;
                        that.scoreboard = that.buildScoreboard();
                    });
                }
                else {
                    this.game = undefined;
                }
            },

            listPlayers: function() {
                if (this.game) {
                    var players = [];
                    for (var i = 0; i < this.game.scores.length; i++) {
                        players.push(this.game.scores[i].player);
                    }
                    return players;
                }
            },


            addRoundClicked: function() {
                this.$.addRoundDialog.open();

            },

            doCancelAddRound: function() {
                this.$.addRoundDialog.close();
            },

            doAddRoundDisabled: function() {
                return !this.round;
            },

            doAddRound: function() {

                var round = this.$.roundEditor.round;

                if (round) {
                    this.push('game.bids', round);

                    for (var i = 0; i < this.game.scores.length; i++) {
                        var playerId = this.game.scores[i].player.player_id;
                        var currentScore = this.game.scores[i].score;

                        this.game.scores[i].score = this.computeUpdatedScore(playerId, currentScore, round, this.game.scores.length);

                        if (round.points_made >= round.points_bid && playerId == round.caller) {
                            this.game.scores[i].made_bid = true;
                        }
                    }

                    this.scoreboard = this.buildScoreboard();
                    this.$.gameController.save(this.game);
                    
                    this.$.roundEditor.reset();
                    this.$.addRoundDialog.close();
                }


            },


            buildScoreboard: function() {
                //given rounds, compute score of each player after each round. 

                var scoreboard = [];

                this.game.scores.sort(function(a, b) {
                    
                    if(a.made_bid == b.made_bid){
                        return b.score - a.score;
                    } else if(a.made_bid && !b.made_bid){
                        return -1;
                    } else if(b.made_bid && !a.made_bid){
                        return 1;
                    }
                });

                var lastRound = {};
                lastRound.scores = [];
                
                for (var i = 0; i < this.game.scores.length; i++) {
                    lastRound.scores.push(0);
                }

                for (var i = 0; i < this.game.bids.length; i++) {
                    var bid = this.game.bids[i];
                    var thisRound = {};
                    thisRound.scores = [];

                    for (var j = 0; j < this.game.scores.length; j++) {
                        thisRound.scores[j] = this.computeUpdatedScore(this.game.scores[j].player.player_id, lastRound.scores[j], bid, this.game.scores.length);
                    }
                    thisRound.bid  = bid;

                    scoreboard.push(thisRound);
                    lastRound = thisRound;
                }

                return scoreboard;
            },

            computeUpdatedScore: function(playerId, currentScore, bid, numPlayers) {
                var newScore;
                var madeBid = bid.points_made >= bid.points_bid;

                if (bid.caller == playerId || bid.partners.indexOf(playerId) >= 0) {
                    if (madeBid) {
                        newScore = currentScore + bid.points_made;

                        //special case for going alone
                        if (bid.partners.length == 0) {
                            newScore += (20 + (numPlayers - 4) * 10);
                        }

                    }
                    else {
                        newScore = currentScore - bid.points_bid;
                    }
                }
                else {
                    //opponent. 
                    newScore = currentScore + 180 - bid.points_made;
                }

                return newScore;
            }

        });
    </script>


</dom-module>