<link rel="import" href="../../imports.html">

<dom-module id="round-editor">

    <style include="rookscore-styles">
        paper-listbox /deep/ .selectable-content {
            @apply(--layout-horizontal);
        }
    </style>


    <template>

        <iron-media-query query="(min-width: 720px)" query-matches="{{wide}}"></iron-media-query>



        <div class="rookscore-round-editor-section-label">Select the caller</div>
        <paper-listbox id="callerList" selected="{{selectedCallerIndex}}">
            <template is="dom-repeat" items="{{players}}" as="player">
                <paper-item class="rookscore-round-editor-player-selection-item">{{buildPlayerNameText(player)}}</paper-item>
            </template>
        </paper-listbox>


        <div class="vertical layout flex">
            <points-selector label="Enter score made" value="{{bidAmount}}"></points-selector>
        </div>


        <div class="rookscore-round-editor-section-label">Select the partners</div>
        <paper-listbox id="partnerList" multi selected-values="{{selectedPartnerIndices}}">
            <template is="dom-repeat" items="{{players}}" as="player">
                <paper-item class="rookscore-round-editor-player-selection-item">{{buildPlayerNameText(player)}}</paper-item>
            </template>
        </paper-listbox>

        <div class="vertical layout flex">
            <points-selector value="{{madeAmount}}" label="Enter score made:"></points-selector>
        </div>



    </template>


    <script>
        Polymer({
            is: "round-editor",

            properties: {
                players: Array,
                bidAmount: Number,
                madeAmount: Number,
                selectedPartnerIndices: Array,
                selectedCallerIndex: Number,
                round: {
                    type: Object,
                    notify: true,
                }
            },

            observers: [
                'roundInputsChanged(players, bidAmount, madeAmount, selectedPartnerIndices, selectedCallerIndex)',
                'roundChanged(round, players)'
            ],

            ready: function() {
                this.reset();
            },

            reset: function() {
                this.selectedPartnerIndices = [];
                this.selectedCallerIndex = -1;
                this.bidAmount = 150;
                this.madeAmount = 150;
            },

            roundChanged: function() {
                this.selectedPartnerIndexes = [];
                for (var i = 0; i < this.players.length; i++) {

                    if (this.players[i].player_id == this.round.caller) {
                        this.selectedCallerIndex = i;
                    }

                    if (this.round.partners.indexOf(this.players[i].player_id) >= 0) {
                        this.selectedPartnerIndexes.push(i);
                    }
                }

                this.bidAmount = this.round.points_bid;
                this.madeAmount = this.round.points_made;
            },

            roundInputsChanged: function() {
                if (this.selectedPartnerIndices) {
                    var partnerIds = [];
                    var opponentIds = [];

                    for (var i = 0; i < this.players.length; i++) {
                        if (this.selectedCallerIndex != i) {
                            if (this.selectedPartnerIndices.indexOf(i) >= 0) {
                                partnerIds.push(this.players[i].player_id)
                            }
                            else {
                                opponentIds.push(this.players[i].player_id);
                            }
                        }
                    }
                }



                if (this.selectedCallerIndex >= 0) {
                    var callerId = this.players[this.selectedCallerIndex].player_id;
                }


                if (this.bidAmount >= 0 && this.madeAmount >= 0 && partnerIds && opponentIds && callerId >= 0) {
                    this.round = {
                        caller: callerId,
                        partners: partnerIds,
                        opponents: opponentIds,
                        points_bid: this.bidAmount,
                        points_made: this.madeAmount
                    };
                }
                else {
                    this.round = undefined;
                }

            },

            buildPlayerNameText: function(player) {
                if (this.wide) {
                    return player.first_name + " " + player.last_name;
                }
                else {
                    return this.buildPlayerInitials(player);
                }
            },

            buildPlayerInitials: function(player) {
                var initials = "";

                if (player.first_name) {
                    initials += player.first_name.charAt(0).toUpperCase();
                }

                if (player.last_name) {
                    initials += player.last_name.charAt(0).toUpperCase();
                }

                return initials;
            },


        })
    </script>
</dom-module>
