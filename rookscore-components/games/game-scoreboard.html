<link rel="import" href="../../imports.html">

<dom-module id="game-scoreboard">



    <style include="rookscore-styles">
        :host {
            @apply(--layout-vertical)
        }
    </style>


    <template>
      
            <rookscore-media-query wide="{{wide}}"></rookscore-media-query>

      
            <div class="rookscore-scoreboard-row">
                <template id="scoresheetHeader" is="dom-repeat" items="{{game.scores}}">
                    <div class="rookscore-scoresheet-header-item">
                        <template is="dom-if" if="{{item.made_bid}}">
                            <iron-icon icon="star"></iron-icon>
                        </template>
                        <template is="dom-if" if="{{wide}}">
                          <span>{{item.player.first_name}}</span> <span>{{item.player.last_name}}</span>  
                        </template>

                        <template is="dom-if" if="{{!wide}}">
                          <span>{{buildPlayerInitials(item.player)}}</span>  
                        </template>

                        
                    </div>
                </template>


                <!-- fixed-size column to display round summary -->
                <div class="rookscore-scoresheet-summary-column"></div>
            </div>

            <div class="flex vertical layout">
                <iron-list id="roundList" items="{{scoreboard}}" class="flex">
                    <template>

                        <div class="vertical layout">
                            <template is="dom-if" if="{{shouldDrawDividerLine(index, item)}}" restamp>
                                <div class="rookscore-scoresheet-divider-line">Dealer divider line</div>
                            </template>
                            <div class="rookscore-scoreboard-row">
                                <template is="dom-repeat" items="{{item.scores}}">
                                    <div class="rookscore-scoresheet-item">{{item}}</paper-item>
                                </template>

                                <div class="rookscore-scoresheet-summary-column" class$="{{computeRoundClass(item)}}">{{buildRoundSummaryText(item)}}</div>
                                </div>

                            </div>
                        </div>
                    </template>
                </iron-list>

            </div>
        </paper-header-panel>


    </template>

    <script>
        Polymer({
            is: "game-scoreboard",

            properties: {
                game: {
                  type: Object,
                }, 
                scoreboard: {
                  type: Object,
                  observer: 'scoreboardChanged'
                }
            },
            
            
            scoreboardChanged: function() {
              this.$.scoresheetHeader.render();
            },
            

            shouldDrawDividerLine: function(index) {
                return index != 0 && index < this.scoreboard.length - 1 && (this.scoreboard.length  - index  ) %  this.game.scores.length == 0;
            },

            computeRoundClass: function(round) {
                if (round.bid.points_made >= round.bid.points_bid) {
                    return "rookscore-scoresheet-successful-bid";
                }
                else {
                    return "rookscore-scoresheet-failed-bid";
                }

            },

            buildRoundSummaryText: function(round) {

                var callingPlayer = this.findPlayerWithID(round.bid.caller);
                var partners = [];
                for (var i = 0; i < round.bid.partners.length; i++) {
                    partners.push(this.findPlayerWithID(round.bid.partners[i]));
                }

                var roundSummary = "";

                if (callingPlayer) {
                    roundSummary += this.buildPlayerInitials(callingPlayer);
                    roundSummary += " (" + round.bid.points_bid + ") ";

                    for (var i = 0; i < partners.length; i++) {
                        roundSummary += this.buildPlayerInitials(partners[i]);
                        if (i < partners.length - 1) {
                            roundSummary += ", "
                        }
                    }

                    roundSummary += " " + round.bid.points_made;
                }

                return roundSummary;
            },

            buildPlayerInitials: function(player) {
                var initials = "";

                if (player.first_name) {
                    initials += player.first_name.charAt(0).toUpperCase();
                }

                if (player.last_name) {
                    initials += player.last_name.charAt(0).toUpperCase();
                }

                return initials;
            },

            findPlayerWithID: function(id) {
                for (var i = 0; i < this.game.scores.length; i++) {
                    if (this.game.scores[i].player.player_id == id) {
                        return this.game.scores[i].player;
                    }
                }
            }
        });
    </script>

</dom-module>